---
import type { GetStaticPaths } from 'astro';

import Layout from '~/layouts/PageLayout.astro';
import PostListItem from '~/components/ui/PostListItem.astro';
import Headline from '~/components/ui/Headline.astro';

import { blogListRobots, getStaticPathsBlogListAll } from '~/utils/blog';
import type { Post } from '~/types';

export const prerender = true;

export const getStaticPaths = (async () => {
  return await getStaticPathsBlogListAll();
}) satisfies GetStaticPaths;

const { posts } = Astro.props as { posts: Post[] };
const totalPosts = posts.length;

// Extract unique filter values at build time
const uniqueAuthors: { slug: string; name: string }[] = [];
const authorSeen = new Set<string>();
const uniqueSeries: { slug: string; title: string }[] = [];
const seriesSeen = new Set<string>();
const uniqueTags: { slug: string; title: string }[] = [];
const tagSeen = new Set<string>();

for (const post of posts) {
  if (post.authors) {
    for (const author of post.authors) {
      const slug = author.name
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
      if (!authorSeen.has(slug)) {
        authorSeen.add(slug);
        uniqueAuthors.push({ slug, name: author.name.replaceAll('-', ' ') });
      }
    }
  }
  if (post.series && !seriesSeen.has(post.series.slug)) {
    seriesSeen.add(post.series.slug);
    uniqueSeries.push({ slug: post.series.slug, title: post.series.title });
  }
  if (post.tags) {
    for (const tag of post.tags) {
      if (!tagSeen.has(tag.slug)) {
        tagSeen.add(tag.slug);
        uniqueTags.push({ slug: tag.slug, title: tag.title });
      }
    }
  }
}

uniqueAuthors.sort((a, b) => a.name.localeCompare(b.name));
uniqueSeries.sort((a, b) => a.title.localeCompare(b.title));
uniqueTags.sort((a, b) => a.title.localeCompare(b.title));

const metadata = {
  title: 'Blog',
  robots: {
    index: blogListRobots?.index,
    follow: blogListRobots?.follow,
  },
  openGraph: {
    type: 'blog',
  },
};
---

<Layout metadata={metadata}>
  <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
    <Headline
      title="The Blog"
      subtitle="Enjoy news, tutorials, resources and other interesting content related to bioinformatics"
    />

    <!-- Filter Bar -->
    <div class="mb-10 p-5 bg-white dark:bg-slate-800/50 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
      <p class="text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-4">Filter Posts</p>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label for="filter-author" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">
            Author
          </label>
          <select
            id="filter-author"
            class="w-full py-3 px-4 text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
          >
            <option value="">All Authors</option>
            {uniqueAuthors.map((a) => <option value={a.slug}>{a.name}</option>)}
          </select>
        </div>

        <div>
          <label for="filter-series" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">
            Series
          </label>
          <select
            id="filter-series"
            class="w-full py-3 px-4 text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
          >
            <option value="">All Series</option>
            {uniqueSeries.map((s) => <option value={s.slug}>{s.title}</option>)}
          </select>
        </div>

        <div>
          <label for="filter-tag" class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">
            Tag
          </label>
          <select
            id="filter-tag"
            class="w-full py-3 px-4 text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
          >
            <option value="">All Tags</option>
            {uniqueTags.map((t) => <option value={t.slug}>{t.title}</option>)}
          </select>
        </div>
      </div>

      <div class="flex items-center justify-between mt-4">
        <p id="results-count" aria-live="polite" class="text-sm text-muted dark:text-slate-400">
          Showing {totalPosts} of {totalPosts} posts
        </p>
        <button
          id="clear-filters"
          type="button"
          class="btn-tertiary inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-primary dark:text-blue-400 hover:text-secondary dark:hover:text-blue-300 transition-colors duration-200"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Clear filters
        </button>
      </div>
    </div>

    <!-- Posts List -->
    <ul id="posts-list">
      {
        posts.map((post) => {
          const authorSlugs = post.authors
            ? post.authors
                .map((a) =>
                  a.name
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '')
                )
                .join('|')
            : '';
          const seriesSlug = post.series?.slug || '';
          const tagSlugs = post.tags ? post.tags.map((t) => t.slug).join('|') : '';

          return (
            <li class="mb-12 md:mb-20" data-authors={authorSlugs} data-series={seriesSlug} data-tags={tagSlugs}>
              <PostListItem post={post} />
            </li>
          );
        })
      }
    </ul>

    <p id="no-results" class="hidden text-center text-gray-500 dark:text-gray-400 py-12 text-lg">
      No posts match the selected filters.
    </p>
  </section>
</Layout>

<script>
  const authorSelect = document.getElementById('filter-author') as HTMLSelectElement;
  const seriesSelect = document.getElementById('filter-series') as HTMLSelectElement;
  const tagSelect = document.getElementById('filter-tag') as HTMLSelectElement;
  const clearBtn = document.getElementById('clear-filters');
  const postsList = document.getElementById('posts-list');
  const resultsCount = document.getElementById('results-count');
  const noResults = document.getElementById('no-results');

  if (authorSelect && seriesSelect && tagSelect && clearBtn && postsList && resultsCount && noResults) {
    const totalPosts = postsList.querySelectorAll('li[data-authors]').length;

    function applyFilters() {
      const author = authorSelect.value;
      const series = seriesSelect.value;
      const tag = tagSelect.value;

      const items = postsList!.querySelectorAll('li[data-authors]');
      let visibleCount = 0;

      items.forEach((li) => {
        const postAuthors = li.getAttribute('data-authors') || '';
        const postSeries = li.getAttribute('data-series') || '';
        const postTags = li.getAttribute('data-tags') || '';

        const matchesAuthor = !author || postAuthors.split('|').includes(author);
        const matchesSeries = !series || postSeries === series;
        const matchesTag = !tag || postTags.split('|').includes(tag);

        if (matchesAuthor && matchesSeries && matchesTag) {
          (li as HTMLElement).style.display = '';
          visibleCount++;
        } else {
          (li as HTMLElement).style.display = 'none';
        }
      });

      resultsCount!.textContent = `Showing ${visibleCount} of ${totalPosts} posts`;
      noResults!.classList.toggle('hidden', visibleCount > 0);

      const params = new URLSearchParams();
      if (author) params.set('author', author);
      if (series) params.set('series', series);
      if (tag) params.set('tag', tag);

      const newUrl = params.toString()
        ? `${window.location.pathname}?${params.toString()}`
        : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function clearFilters() {
      authorSelect.value = '';
      seriesSelect.value = '';
      tagSelect.value = '';
      applyFilters();
    }

    function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const author = params.get('author');
      const series = params.get('series');
      const tag = params.get('tag');

      if (author) authorSelect.value = author;
      if (series) seriesSelect.value = series;
      if (tag) tagSelect.value = tag;

      if (author || series || tag) {
        applyFilters();
      }
    }

    authorSelect.addEventListener('change', applyFilters);
    seriesSelect.addEventListener('change', applyFilters);
    tagSelect.addEventListener('change', applyFilters);
    clearBtn.addEventListener('click', clearFilters);

    initFromUrl();
  }
</script>
