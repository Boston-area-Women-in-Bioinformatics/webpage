---
//import { splitEvents } from '~/content/utils.js'; // Import your event handling logic
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
//import { playlists } from '../utils/data';
import FormattedDate from '~/components/FormattedDate.astro';
import EventAddress from 'src/components/EventAddress.astro';
import Button from '~/components/ui/Button.astro';
//import { Icon } from 'astro-icon/components';

// Get all future events, excluding partner events for homepage display
const future_events = (
  await getCollection(
    'event',
    ({ data }: CollectionEntry<'event'>) => new Date(data.dateTime) > new Date() && !data.partnerEvent
  )
).sort((b, a) => b.data.dateTime.valueOf() - a.data.dateTime.valueOf());

const next_event = future_events[0];

// Breaking Title After Colon or Dash (only if event exists)
let colonIndex: number | undefined;
let dashIndex: number | undefined;
let breakIndex: number | undefined;
let hasBreak: boolean | undefined;
let firstLine: string | undefined;
let secondLine: string | undefined;
let image_class: string | undefined;

if (next_event) {
  // Find the first colon or dash
  colonIndex = next_event.data.title.indexOf(':');
  dashIndex = next_event.data.title.indexOf('-');

  // Choose the earliest one (if either exists)
  breakIndex = [colonIndex, dashIndex].filter((i) => i !== -1).sort((a, b) => a - b)[0];

  hasBreak = breakIndex !== undefined;
  firstLine = hasBreak ? next_event.data.title.slice(0, breakIndex + 1) : next_event.data.title;
  secondLine = hasBreak ? next_event.data.title.slice(breakIndex + 1).trim() : '';
  image_class = `border border-gray-200 dark:border-gray-700 shadow mx-auto h-auto rounded-md ${next_event.data.imgpos}`;
}
---

{
  future_events.length === 0 ? (
    <div class="relative m-auto max-w-6xl lg:flex lg:items-center lg:gap-8">
      <div class="w-full lg:w-2/3 text-center lg:text-left mb-8 lg:mb-0">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 font-heading">
          New Events Coming Soon!
        </h1>
        <p class="text-lg sm:text-xl text-muted mb-6 dark:text-slate-300">
          We're brewing up some exciting gatherings and can't wait to share them with you. Subscribe to our Luma page to
          stay in the loop!
        </p>
        <div class="flex gap-4 justify-center lg:justify-start flex-wrap">
          <a
            href="https://luma.com/bwib"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center px-6 py-3.5 md:px-8 rounded-full bg-gradient-to-r from-pink-500 via-yellow-500 to-green-500 hover:opacity-90 transition font-semibold text-base text-white"
          >
            Follow Us on Luma
            <svg class="w-5 h-5 ml-1 -mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </a>
          <Button variant="secondary" text="Watch Past Events" href="/events/archived" icon="tabler:history" />
        </div>
      </div>
      <div class="lg:w-1/3">
        <img
          src="/photos/eventFairy2.png"
          alt="Fairy at a desk with calendar pages scattered around"
          class="mx-auto h-auto rounded-md w-32 sm:w-48 md:w-64 lg:w-80 dark:[filter:brightness(1.5)_saturate(0.8)]"
          loading="lazy"
        />
      </div>
    </div>
  ) : (
    <div class="relative m-auto max-w-6xl intersect-once intercept-no-queue motion-safe:md:intersect:animate-fade motion-safe:md:opacity-0 intersect-quarter lg:flex lg:items-center">
      <div class="lg:w-2/5 {image_class}">
        <img
          src={next_event.data.image.src}
          alt={next_event.data.image.alt}
          class={`${image_class} hidden lg:block`}
          transition:name="playlist ${event.id} image"
        />
      </div>
      <div class="sm:p-4 w-full lg:w-2/3 text-center xs:text-left">
        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 font-heading intersect-once"
          transition:name="playlist ${event.id} title"
        >
          Upcoming Event
        </h1>
        <h2
          class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold leading-tighter tracking-tighter mb-4 font-heading intersect-once"
          transition:name="playlist ${event.id} title"
        >
          {firstLine}
          {secondLine && <br />}
          {secondLine}
        </h2>
        <div class="text-md sm:text-lg md:text-xl lg:text-2xl">
          <div class="mb-4">
            <FormattedDate date={next_event.data.dateTime} />
          </div>
          <div class="mb-4">
            <EventAddress artists={next_event.data.location || []} />
          </div>
        </div>
        <Button
          variant="primary"
          href={`/events/${next_event.id}`}
          text="More Information"
          icon="tabler:square-rounded-arrow-right"
        />
      </div>
      <img
        src={next_event.data.image.src}
        alt={next_event.data.image.alt}
        class={`${image_class}  block lg:hidden`}
        transition:name="playlist ${event.id} image"
      />
    </div>
  )
}
