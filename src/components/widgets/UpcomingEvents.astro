---
//import { splitEvents } from '~/content/utils.js'; // Import your event handling logic
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
//import { playlists } from '../utils/data';
import FormattedDate from '~/components/FormattedDate.astro';
import EventAddress from 'src/components/EventAddress.astro';
import Button from '~/components/ui/Button.astro';
import Hero2 from '~/components/widgets/Hero2.astro';
//import { Icon } from 'astro-icon/components';

const future_events = (
  await getCollection('event', ({ data }: CollectionEntry<'event'>) => new Date(data.dateTime) > new Date())
).sort((b, a) => b.data.dateTime.valueOf() - a.data.dateTime.valueOf());

const next_event = future_events[0];

// Breaking Title After Colon or Dash (only if event exists)
let colonIndex: number | undefined;
let dashIndex: number | undefined;
let breakIndex: number | undefined;
let hasBreak: boolean | undefined;
let firstLine: string | undefined;
let secondLine: string | undefined;
let image_class: string | undefined;

if (next_event) {
  // Find the first colon or dash
  colonIndex = next_event.data.title.indexOf(':');
  dashIndex = next_event.data.title.indexOf('-');

  // Choose the earliest one (if either exists)
  breakIndex = [colonIndex, dashIndex].filter((i) => i !== -1).sort((a, b) => a - b)[0];

  hasBreak = breakIndex !== undefined;
  firstLine = hasBreak ? next_event.data.title.slice(0, breakIndex + 1) : next_event.data.title;
  secondLine = hasBreak ? next_event.data.title.slice(breakIndex + 1).trim() : '';
  image_class = `border border-gray-200 dark:border-gray-700 shadow mx-auto h-auto rounded-md ${next_event.data.imgpos}`;
}
---

{
  future_events.length === 0 ? (
    <Hero2
      title="New Events Coming Soon!"
      subtitle="We're brewing up some exciting gatherings and can't wait to share them with you. Check back soon or join our slack to be the first to know!"
      image={{ src: '/photos/eventFairy.png', alt: 'Event Fairy', class: 'dark:[filter:brightness(1.5)_saturate(0.8)]' }}
      imageBefore={true}
      padding="py-16"
      actions={[
        {
          variant: 'primary',
          text: 'Join Our Community',
          href: 'https://join.slack.com/t/boston-women-bioinfo/shared_invite/zt-2y78bc7n7-W4TE7kuz8HGz4pzShTeZMQ',
          icon: 'tabler:brand-slack',
          target: '_blank',
        },
        {
          variant: 'secondary',
          text: 'View Past Events',
          href: '/events/archived',
          icon: 'tabler:history',
        },
      ]}
    />
  ) : (
    <div class="relative m-auto max-w-6xl intersect-once intercept-no-queue motion-safe:md:intersect:animate-fade motion-safe:md:opacity-0 intersect-quarter lg:flex lg:items-center">
      <div class="lg:w-2/5 {image_class}">
        <img
          src={next_event.data.image.src}
          alt={next_event.data.image.alt}
          class={`${image_class} hidden lg:block`}
          transition:name="playlist ${event.id} image"
        />
      </div>
      <div class="sm:p-4 w-full lg:w-2/3 text-center xs:text-left">
        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 font-heading intersect-once"
          transition:name="playlist ${event.id} title"
        >
          Upcoming Event
        </h1>
        <h2
          class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold leading-tighter tracking-tighter mb-4 font-heading intersect-once"
          transition:name="playlist ${event.id} title"
        >
          {firstLine}
          {secondLine && <br />}
          {secondLine}
        </h2>
        <div class="text-md sm:text-lg md:text-xl lg:text-2xl">
          <div class="mb-4">
            <FormattedDate date={next_event.data.dateTime} />
          </div>
          <div class="mb-4">
            <EventAddress artists={next_event.data.location || []} />
          </div>
        </div>
        <Button
          variant="primary"
          href={`/events/${next_event.id}`}
          text="More Information"
          icon="tabler:square-rounded-arrow-right"
        />
      </div>
      <img
        src={next_event.data.image.src}
        alt={next_event.data.image.alt}
        class={`${image_class}  block lg:hidden`}
        transition:name="playlist ${event.id} image"
      />
    </div>
  )
}
