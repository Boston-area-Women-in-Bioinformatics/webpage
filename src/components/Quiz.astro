---
interface Answer {
  text: string;
  biobank: string;
}

interface Question {
  question: string;
  answers: Answer[];
}

interface Result {
  name: string;
  description: string;
  emoji?: string;
  color?: string;
  image?: string;
  imageCaption?: string;
  url?: string;
}

interface Props {
  questions: Question[];
  results: Record<string, Result>;
  title?: string;
}

const { questions, results, title = 'Take the Quiz!' } = Astro.props;
---

<div class="quiz-container max-w-4xl mx-auto px-4 py-8">
  <!-- Quiz Section -->
  <div id="quiz" class="space-y-8">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-bold text-gray-900 mb-4">{title}</h2>
      <p class="text-lg text-gray-600">Answer honestlyâ€”we can see your citation history.</p>
    </div>

    {
      questions.map((q, index) => (
        <div
          class="question bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100 hover:border-blue-200 transition-all duration-300"
          id={`q${index}`}
        >
          <h3 class="text-xl font-semibold text-gray-900 mb-4">
            {index + 1}. {q.question}
          </h3>
          <div class="space-y-3">
            {q.answers.map((answer) => (
              <label class="flex items-start p-4 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors duration-200 group border-2 border-transparent hover:border-blue-300">
                <input
                  type="radio"
                  name={`q${index}`}
                  value={answer.biobank}
                  class="mt-1 mr-4 w-4 h-4 text-blue-600 focus:ring-blue-500 focus:ring-2 cursor-pointer"
                />
                <span class="text-gray-700 group-hover:text-gray-900 font-medium flex-1">{answer.text}</span>
              </label>
            ))}
          </div>
        </div>
      ))
    }

    <div class="text-center mt-12">
      <button id="submitBtn" type="button" class="btn-primary">
        See Your Result!
        <svg class="w-5 h-5 ml-1 -mr-1.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
      <p id="errorMessage" class="text-red-600 mt-4 hidden font-medium">
        Please answer all questions before submitting!
      </p>
    </div>
  </div>

  <!-- Result Section -->
  <section id="result" class="hidden relative not-prose bg-white dark:bg-slate-900">
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6">
      <div class="py-12 md:py-20">
        <div class="text-center mb-8 animate-fade-in">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Your Biobank Is:</h2>
          <div class="flex items-center justify-center gap-3 mb-6">
            <span id="resultEmoji" class="text-6xl"></span>
            <h3
              id="resultName"
              class="text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent"
            >
            </h3>
          </div>
        </div>

        <!-- Result Card -->
        <div id="resultCard" class="relative m-auto max-w-5xl">
          <!-- Image -->
          <div id="resultImageContainer" class="hidden mb-8">
            <div class="relative max-w-2xl mx-auto">
              <img id="resultImage" src="" alt="" class="mx-auto h-auto rounded-md w-full shadow-lg" />
              <p id="resultImageCaption" class="text-xs text-gray-500 dark:text-gray-400 italic mt-2 text-center"></p>
            </div>
          </div>

          <!-- Content -->
          <div class="text-center mb-8">
            <p id="resultDescription" class="text-lg text-gray-700 dark:text-gray-300 leading-relaxed mb-8 text-left">
            </p>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <button id="retakeBtn" type="button" class="btn-secondary">
                Take Quiz Again
                <svg class="w-5 h-5 ml-1 -mr-1.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  ></path>
                </svg>
              </button>
              <button id="shareBtn" type="button" class="btn-primary">
                Share Result
                <svg class="w-5 h-5 ml-1 -mr-1.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Fun Stats -->
        <div
          class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 max-w-4xl mx-auto"
        >
          <h4 class="font-bold text-lg text-gray-900 dark:text-white mb-3">ðŸ“Š Your Quiz Stats:</h4>
          <div id="statsDisplay" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4"></div>
        </div>

        <!-- All Other Results -->
        <div class="mt-12 max-w-5xl mx-auto">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">Explore All Biobanks</h3>
          <div id="allResultsDisplay" class="space-y-6"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<script define:vars={{ results }} is:inline>
  function calculateResult() {
    const scores = {};
    const questions = document.querySelectorAll('.question');
    let allAnswered = true;

    // Reset previous styling
    questions.forEach((q) => {
      q.classList.remove('ring-4', 'ring-red-300');
    });

    // Count votes and check if all answered
    questions.forEach((q) => {
      const selected = q.querySelector('input[type="radio"]:checked');
      if (!selected) {
        allAnswered = false;
        q.classList.add('ring-4', 'ring-red-300');
        q.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        const value = selected.value;
        scores[value] = (scores[value] || 0) + 1;
      }
    });

    if (!allAnswered) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.classList.remove('hidden');
      setTimeout(() => errorMsg.classList.add('hidden'), 3000);
      return;
    }

    // Find the winner
    let maxScore = 0;
    let winner = Object.keys(results)[0];
    let tiedCount = 0;

    for (const [biobank, score] of Object.entries(scores)) {
      if (score > maxScore) {
        maxScore = score;
        winner = biobank;
        tiedCount = 1;
      } else if (score === maxScore) {
        tiedCount++;
      }
    }

    // Check if there's a tie (multiple biobanks with same max score)
    if (tiedCount > 1) {
      winner = 'multianalyst';
    }

    // Display result with animation
    let resultData = results[winner];

    // Fallback if result doesn't exist (e.g., 'multianalyst' not defined yet)
    if (!resultData) {
      console.warn(`Result '${winner}' not found. Falling back to first available result.`);
      winner = Object.keys(results)[0];
      resultData = results[winner];
    }

    document.getElementById('resultName').textContent = resultData.name;
    document.getElementById('resultDescription').innerHTML = resultData.description;
    document.getElementById('resultEmoji').textContent = resultData.emoji || 'ðŸ”¬';

    // Display image if it exists
    const resultImageContainer = document.getElementById('resultImageContainer');
    const resultImage = document.getElementById('resultImage');
    const resultImageCaption = document.getElementById('resultImageCaption');
    if (resultData.image) {
      resultImage.src = resultData.image;
      resultImage.alt = resultData.name;
      resultImageContainer.classList.remove('hidden');
      if (resultData.imageCaption) {
        resultImageCaption.innerHTML = resultData.imageCaption;
      } else {
        resultImageCaption.innerHTML = '';
      }
    } else {
      resultImageContainer.classList.add('hidden');
    }

    // Display stats
    displayStats(scores);

    // Display all results
    displayAllResults();

    // Smooth scroll and transition
    document.getElementById('quiz').classList.add('hidden');
    document.getElementById('result').classList.remove('hidden');
    document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function displayStats(scores) {
    const statsDisplay = document.getElementById('statsDisplay');
    const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);

    statsDisplay.innerHTML = sortedScores
      .map(
        ([biobank, score]) => `
      <div class="bg-white rounded-lg p-3 shadow">
        <div class="text-2xl font-bold text-blue-600">${score}</div>
        <div class="text-xs text-gray-600 font-medium">${results[biobank].name}</div>
      </div>
    `
      )
      .join('');
  }

  function displayAllResults() {
    const allResultsDisplay = document.getElementById('allResultsDisplay');

    allResultsDisplay.innerHTML = Object.entries(results)
      .map(([key, result]) => {
        // Skip the multianalyst result in the explore section
        if (key === 'multianalyst') return '';

        const visitLink = result.url
          ? `<a href="${result.url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 font-medium hover:text-blue-800 dark:hover:text-blue-300 mt-2">
              <span>Visit ${result.name}</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
            </a>`
          : '';

        const hasImage = result.image
          ? `<div class="flex-shrink-0 w-full md:w-64">
            <div class="md:h-48 overflow-hidden rounded-md">
              <img src="${result.image}" alt="${result.name}" class="w-full h-full object-cover" />
            </div>
            ${result.imageCaption ? `<p class="text-xs text-gray-500 dark:text-gray-400 italic mt-2">${result.imageCaption}</p>` : ''}
            ${visitLink}
          </div>`
          : '';

        return `
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden">
            <div class="flex flex-col md:flex-row gap-6 p-6">
              ${hasImage}
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-4">
                  <span class="text-4xl">${result.emoji || 'ðŸ”¬'}</span>
                  <h4 class="text-2xl font-bold text-gray-900 dark:text-white">${result.name}</h4>
                </div>
                <p class="text-base text-gray-700 dark:text-gray-300 leading-relaxed">${result.description}</p>
              </div>
            </div>
          </div>
        `;
      })
      .join('');
  }

  function resetQuiz() {
    document.getElementById('quiz').classList.remove('hidden');
    document.getElementById('result').classList.add('hidden');
    document.querySelectorAll('input[type="radio"]').forEach((input) => {
      input.checked = false;
    });
    document.querySelectorAll('.question').forEach((q) => {
      q.classList.remove('ring-4', 'ring-red-300');
    });
    document.getElementById('errorMessage').classList.add('hidden');
    document.getElementById('quiz').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function shareResult() {
    const resultName = document.getElementById('resultName').textContent;
    const resultEmoji = document.getElementById('resultEmoji').textContent;
    const shareText = `${resultEmoji} I got ${resultName} on the biobank quiz! What's yours?`;
    const shareUrl = window.location.href;

    // Create LinkedIn share URL
    const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`;

    // Try native share first (mobile)
    if (navigator.share) {
      navigator
        .share({
          title: 'My Biobank Quiz Result',
          text: shareText,
          url: shareUrl,
        })
        .catch((err) => console.log('Error sharing:', err));
    } else {
      // Desktop: Open LinkedIn share dialog
      window.open(linkedInUrl, '_blank', 'width=600,height=600');
    }
  }

  // Event listeners
  document.getElementById('submitBtn')?.addEventListener('click', calculateResult);
  document.getElementById('retakeBtn')?.addEventListener('click', resetQuiz);
  document.getElementById('shareBtn')?.addEventListener('click', shareResult);

  // Enable submit button when questions are answered
  document.querySelectorAll('input[type="radio"]').forEach((input) => {
    input.addEventListener('change', () => {
      document.getElementById('errorMessage')?.classList.add('hidden');
    });
  });
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.6s ease-out;
  }

  /* Custom radio button styling */
  input[type='radio']:checked + span {
    color: #1e40af;
    font-weight: 600;
  }

  input[type='radio']:checked {
    accent-color: #3b82f6;
  }

  /* Smooth transitions */
  .question {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .question:hover {
    transform: translateY(-2px);
  }
</style>
